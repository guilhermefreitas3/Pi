<!DOCTYPE html>
<html>
<head>
    <title>Gráfico não numérico</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8>
    <meta name="viewport" content="width=device-width, initial-scale=0.48">
</head>
<body>
    <!-- Canvas -->
    <div>
        <canvas width="900" height="900" id="Grafico">
            Browser não suportado...
        </canvas>
    </div>
    
    
       
           
        <!-- Script -->
        <script type="text/javascript">
            function init() {
                window.onmessage = (event) => {
                    console.log("Event=" + event.data);
                    if (event.data) {
                        dadosObter(event.data);
                        myPie.ClearBackground();
                        myPie.DrawBackground(outlineColor);
                        myPie.PieLabels(labelColor, false);
                        myPie.PieFill();
                        console.log(`HTML Component received a message: ${event.data}`);
                        // additional code here
                    }
                }
            }

            function sendReturnMessage(msg) {
                window.parent.postMessage(msg, "*");
            }

            // ==========================================================================================   BEGIN SCRIPT

            // ================================================   CANVAS:
            var rodaCanvas = document.getElementById("Grafico");
            ctx = rodaCanvas.getContext("2d");
            // --------  Fator de corre??o da posi??o do canvas:
            var canvasRect = rodaCanvas.getBoundingClientRect();
            var canvasLeft = canvasRect.left;
            var canvasTop = canvasRect.top;
            // -------------------------------------------------

            var pie_CenterX = rodaCanvas.width / 2;
            var pie_CenterY = rodaCanvas.height / 2;
            var pie_Radius = rodaCanvas.width / 3.5;
            var offset = 30;

            var cX = pie_CenterX;
            var cY = pie_CenterY;
            var p1X = pie_CenterX + pie_Radius;
            var p1Y = pie_CenterY;

            var label_Radius = pie_Radius + 10;                 // labels outside the circle
            var unit_Radius = pie_Radius / 100;                 // 1% of total radius
            var labelFont = "14px Arial";                     // "12px Arial";
            var pie_Slices = 10;                                // 10 slices in pie
            var sweep_Angle = 360 / pie_Slices;                 // pie slice = 10% of circle (36 graus)

            var labelOriginal = "";

            var moving = false;
            var primeValue = -1;
            var primeSlice = -1;
            var primeRadius = -1;

            var rotating = false;
            

            // ------------------------------------------------- Inicial values, labels, colors and angles:

           

            var myValuesBackup = {
                "slice0": 0,
                "slice1": 0,
                "slice2": 0,
                "slice3": 0,
                "slice4": 0,
                "slice5": 0,
                "slice6": 0,
                "slice7": 0,
                "slice8": 0,
                "slice9": 0
            };

            var bgColor = "White";              // background color
            var outlineColor = "LightGray";     // outline color
            var labelColor = "Black ";          // label color

            var myColors = {
                "slice0": "DarkKhaki",
                "slice1": "DeepSkyBlue",
                "slice2": "DarkGoldenrod",
                "slice3": "DarkMagenta",
                "slice4": "Tomato",
                "slice5": "RoyalBlue",
                "slice6": "Crimson",
                "slice7": "DarkGreen",
                "slice8": "CadetBlue",
                "slice9": "Orange"
            };

            var myColorsBackup = {
                "slice0": "",
                "slice1": "",
                "slice2": "",
                "slice3": "",
                "slice4": "",
                "slice5": "",
                "slice6": "",
                "slice7": "",
                "slice8": "",
                "slice9": ""
            };

            var myLabels = {                    // MAX: 20 chars !
                "slice0": "Agente Comunitário de Saúde",
                "slice1": "Ajustador Mecânico",
                "slice2": "Professor de Nível Superior na Educação Infantil",
                "slice3": "Mecânico de Manutenção de Máquinas",
                "slice4": "Atendente Comercial",
                "slice5": "Leiturista",
                "slice6": "Topógrafo",
                "slice7": "Pintor de Estruturas Metálicas",
                "slice8": "Auxiliar de Cartório",
                "slice9": "Eletricita de Edifícios"                            
            };
            var myValues = {
                "slice0": 27.8,
                "slice1": 23.4,
                "slice2":23.3,
                "slice3":16.4,
                "slice4":14.1,
                "slice5":12.3,
                "slice6":13,
                "slice7":12.8,
                "slice8":12.7,
                "slice9": 13.8 
            };

            var myAngles = {
                "slice0": 0 * sweep_Angle,
                "slice1": 1 * sweep_Angle,
                "slice2": 2 * sweep_Angle,
                "slice3": 3 * sweep_Angle,
                "slice4": 4 * sweep_Angle,
                "slice5": 5 * sweep_Angle,
                "slice6": 6 * sweep_Angle,
                "slice7": 7 * sweep_Angle,
                "slice8": 8 * sweep_Angle,
                "slice9": 9 * sweep_Angle
            };

            function DegreeToRadian(angle) {
                return Math.PI * angle / 180;
            }

            function RadianToDegree(angle) {
                return angle * (180 / Math.PI);
            }

            function RandomValue(min, max) {
                return Math.floor(Math.random() * (max - min + 1) + min);
            }

            function FindAngle(s1p1X, s1p1Y, s1p2X, s1p2Y, s2p1X, s2p1Y, s2p2X, s2p2Y) {
                // Find the angle between two segments:
                // ------------------------------------
                // Let s1 and s2 the segments, so you can calculate the angle of each using:
                //  atan2(s.p1.y - s.p2.y, s.p1.x - s.p2.x)
                //  where p1 and p2 are the two points defining s;
                // ------------------------------------
                var theta1 = Math.atan2(s1p1Y - s1p2Y, s1p1X - s1p2X);
                var theta2 = Math.atan2(s2p1Y - s2p2Y, s2p1X - s2p2X);
                // Taking the value of the difference, you get the angle between the segments:
                var angle = theta1 - theta2;

                return 2 * Math.PI - angle;
            }

            function DrawLine(ctx, startX, startY, endX, endY, color) {
                ctx.strokeStyle = color;
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.lineTo(endX, endY);
                ctx.stroke();
            }

            function DrawRect(ctx, startX, startY, endX, endY, color) {
                ctx.strokeStyle = color;
                ctx.strokeRect(startX, startY, endX, endY);
            }

            function DrawArc(ctx, centerX, centerY, radius, startAngle, endAngle, color) {
                ctx.lineWidth = 2;
                ctx.strokeStyle = color;
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                ctx.stroke();
                ctx.lineWidth = 1;
            }

            function DrawSlice(ctx, centerX, centerY, radius, startAngle, endAngle, color, lWidth) {
                // Outline:
                if (radius > 0) {
                    ctx.lineWidth = lWidth;
                    ctx.strokeStyle = color;
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius - 1, startAngle, endAngle);
                    ctx.lineTo(centerX, centerY);
                    ctx.closePath();
                    ctx.stroke();
                    ctx.lineWidth = 1;
                }
            }

            function FillSlice(ctx, centerX, centerY, radius, startAngle, endAngle, color) {
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                ctx.closePath();
                ctx.fill();
            }

            function DrawLabel(ctx, slice, label, color) {
                // Position the labels outside the slice's edge:
                // ---------------------------------------------
                var labelAngle = Math.PI * (myAngles[slice] + sweep_Angle / 2) / 180;
                var angle = myAngles[slice] + sweep_Angle;
                var labelX = pie_CenterX + label_Radius * Math.cos(labelAngle);
                var labelY = pie_CenterY + label_Radius * Math.sin(labelAngle);
                ctx.font = labelFont;

               

                var label_Width = 0;
                var label_Height = 0;

                if (color === bgColor)
                    label_Width = rodaCanvas.clientWidth / 5;
                else
                    label_Width = parseInt(ctx.measureText(label).width);
                label_Height = parseInt(labelFont);

                label_Width = label_Width + 5;
                label_Height = label_Height + 5;

                //if (color === bgColor) alert("label - Width: " + label_Width + "  Height: " + label_Height);

                // adjust for label width | height:
                if (angle > 108 && angle < 288)
                    labelX = labelX - label_Width;
                if (angle === 288 || angle === 108)
                    labelX = labelX - label_Width / 2;
                if (angle >= 0 && angle <= 180)
                    labelY = labelY + label_Height / 2;

                labelX = Math.round(labelX);
                labelY = Math.round(labelY);

                // clear label:
                //DrawRect(ctx, labelX, labelY - (label_Height - 4), label_Width, label_Height, "Blue");        // --- For tests only !
                ctx.fillStyle = bgColor;
                ctx.fillRect(labelX, labelY - (label_Height - 4), label_Width, label_Height);

                // draw label:
                ctx.fillStyle = color;
                ctx.fillText(label, labelX, labelY);
            }

            


            function PieBackup() {
                var slice = 0;
                for (s = 0; s < pie_Slices; s++) {
                    slice = "slice" + s;
                    myValuesBackup[slice] = myValues[slice];
                    myColorsBackup[slice] = myColors[slice];
                }
            }

            function PieRestore() {
                var slice = 0;
                for (s = 0; s < pie_Slices; s++) {
                    slice = "slice" + s;
                    myValues[slice] = myValuesBackup[slice];
                    myColors[slice] = myColorsBackup[slice];
                }
            }

            // ------------------------------
            //   canvas function:  .clear()
            // ------------------------------
            CanvasRenderingContext2D.prototype.clear =
                CanvasRenderingContext2D.prototype.clear || function (preserveTransform) {
                    if (preserveTransform) {
                        this.save();
                        this.setTransform(1, 0, 0, 1, 0, 0);
                    }
                    this.rect(0, 0, this.canvas.width, this.canvas.height);
                    this.fillStyle = bgColor;
                    this.fill();
                    if (preserveTransform) {
                        this.restore();
                    }
                };

            // --------------------------
            // ---------------------  Pie
            // --------------------------
            var Pie = function (options) {
                this.options = options;
                this.canvas = options.canvas;
                this.ctx = this.canvas.getContext("2d");

                this.ClearBackground = function () {
                    ctx.clear(true);
                };

                this.DrawBackground = function (color) {
                    
                    // draw circle:
                    DrawArc(ctx, pie_CenterX, pie_CenterY, pie_Radius + 1.8, 0, 2 * Math.PI, color);
                };

                this.PieLabels = function (labelColor, percent) {
                    for (slice in this.options.label) {
                        if (percent)
                            label = this.options.value[slice] + "%";
                        else
                            label = this.options.label[slice];
                        DrawLabel(                          // clear
                            ctx,
                            slice,
                            label,
                            bgColor
                        );
                        DrawLabel(                          // draw
                            ctx,
                            slice,
                            label,
                            labelColor
                        );
                    }
                };

                this.PieFill = function () {
                    for (slice in this.options.value) {
                        value = this.options.value[slice];
                        color = this.options.color[slice];
                        angle = this.options.angle[slice];
                        var sliceRadius = unit_Radius * value;
                        FillSlice(
                            ctx,
                            pie_CenterX,
                            pie_CenterY,
                            sliceRadius,
                            DegreeToRadian(angle),
                            DegreeToRadian(angle + sweep_Angle),
                            color
                        );
                        DrawSlice(
                            ctx,
                            pie_CenterX,
                            pie_CenterY,
                            sliceRadius,
                            DegreeToRadian(angle),
                            DegreeToRadian(angle + sweep_Angle),
                            bgColor,     // color
                            1
                        );
                    }
                };

                this.PieOutline = function (outColor) {
                    for (slice in this.options.value) {
                        value = this.options.value[slice];
                        //color = this.options.color[slice];
                        angle = this.options.angle[slice];
                        var sliceRadius = unit_Radius * value;
                        DrawSlice(
                            ctx,
                            pie_CenterX,
                            pie_CenterY,
                            sliceRadius,
                            DegreeToRadian(angle),
                            DegreeToRadian(angle + sweep_Angle),
                            outColor,
                            2
                        );
                    }
                };

                this.PieClear = function () {
                    for (slice in this.options.value) {
                        angle = this.options.angle[slice];
                        FillSlice(
                            ctx,
                            pie_CenterX,
                            pie_CenterY,
                            pie_Radius,
                            DegreeToRadian(angle),
                            DegreeToRadian(angle + sweep_Angle),
                            bgColor
                        );
                        DrawSlice(
                            ctx,
                            pie_CenterX,
                            pie_CenterY,
                            pie_Radius,
                            DegreeToRadian(angle),
                            DegreeToRadian(angle + sweep_Angle),
                            bgColor,
                            2
                        );
                    }
                };
            };

            //  =============================================
            //  =======================================  MAIN
            //  =============================================

            var myPie = new Pie({
                canvas: rodaCanvas,
                value: myValues,
                color: myColors,
                label: myLabels,
                angle: myAngles
            });
            myPie.ClearBackground();
            myPie.DrawBackground(outlineColor);
            myPie.PieLabels(labelColor, false);
            myPie.PieFill();
            

            // ==========================================================================================   END SCRIPT
        </script>
     
</body>
</html>